<div class="container mt-5 mb-5" style="min-height: 80vh;">
    <h2 class="fw-bold mb-4 text-dark">Checkout</h2>

    <div class="row g-4">

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">

                    <form [formGroup]="checkoutForm">

                        <h5 class="fw-bold mb-4 text-secondary">Shipping Information</h5>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">FULL NAME</label>
                                <input type="text" class="form-control" placeholder="e.g. Ahmed Ali"
                                    formControlName="fullName" [class.is-invalid]="isFieldInvalid('fullName')">
                                <div class="invalid-feedback">Full name is required.</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">PHONE NUMBER</label>
                                <input type="tel" class="form-control" placeholder="01xxxxxxxxx" formControlName="phone"
                                    [class.is-invalid]="isFieldInvalid('phone')">
                                <div class="invalid-feedback">Valid phone number required.</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted">STREET ADDRESS</label>
                                <input type="text" class="form-control" placeholder="Building, Street, Apt..."
                                    formControlName="address" [class.is-invalid]="isFieldInvalid('address')">
                                <div class="invalid-feedback">Address is required.</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">CITY</label>
                                <input type="text" class="form-control" placeholder="e.g. Nasr City"
                                    formControlName="city" [class.is-invalid]="isFieldInvalid('city')">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">GOVERNORATE</label>
                                <div class="input-group has-validation">
                                    <select class="form-select" formControlName="governorateId"
                                        [class.is-invalid]="isFieldInvalid('governorateId')">
                                        <option [ngValue]="null" disabled>Select Governorate</option>
                                        @for (gov of currentGovernorates; track gov.id) {
                                        <option [value]="gov.id">
                                            {{ gov.governorateName }} (+{{ gov.deliveryPrice }} EGP)
                                        </option>
                                        }
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                                        data-bs-target="#manageGovModal" title="Manage Areas">
                                        <i class="bi bi-gear-fill"></i>
                                    </button>
                                    <div class="invalid-feedback">Please select your location.</div>
                                </div>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25 my-4">

                        <h5 class="fw-bold mb-4 text-secondary">Payment Options</h5>

                        <div class="card mb-3 shadow-sm cursor-pointer position-relative overflow-hidden transition-all"
                            [class.border-primary]="checkoutForm.get('onlinePaymentType')?.value === 'full'"
                            [class.bg-primary-subtle]="checkoutForm.get('onlinePaymentType')?.value === 'full'"
                            (click)="checkoutForm.patchValue({onlinePaymentType: 'full'})">

                            <div class="card-body d-flex align-items-center p-3">
                                <div class="form-check">
                                    <input class="form-check-input fs-5" type="radio"
                                        formControlName="onlinePaymentType" value="full" id="payFull">
                                </div>
                                <label class="form-check-label ms-3 w-100 cursor-pointer" for="payFull">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-dark">Pay Full Amount</span>
                                        <span class="fw-bold text-primary fs-5">
                                            {{ cartTotal + deliveryCost | currency:'EGP ' }}
                                        </span>
                                    </div>
                                    <div class="small text-muted mt-1">
                                        Pay for products & delivery now. <span class="text-success fw-medium">No cash
                                            needed on delivery.</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="card mb-3 shadow-sm cursor-pointer position-relative overflow-hidden transition-all"
                            [class.border-primary]="checkoutForm.get('onlinePaymentType')?.value === 'deposit'"
                            [class.bg-primary-subtle]="checkoutForm.get('onlinePaymentType')?.value === 'deposit'"
                            (click)="checkoutForm.patchValue({onlinePaymentType: 'deposit'})">

                            <div class="card-body d-flex align-items-center p-3">
                                <div class="form-check">
                                    <input class="form-check-input fs-5" type="radio"
                                        formControlName="onlinePaymentType" value="deposit" id="payDeposit">
                                </div>
                                <label class="form-check-label ms-3 w-100 cursor-pointer" for="payDeposit">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-dark">Pay Deposit Only</span>
                                        <span class="fw-bold text-primary fs-5">
                                            {{ deliveryCost | currency:'EGP ' }}
                                        </span>
                                    </div>
                                    <div class="small text-muted mt-1">
                                        Pay shipping now. The rest
                                        <strong class="text-danger">({{ cartTotal | currency:'EGP ' }})</strong>
                                        will be collected on delivery.
                                    </div>
                                </label>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25 my-4">

                        <hr class="text-muted opacity-25 my-4">

                        <h5 class="fw-bold mb-4 text-secondary">Payment Method</h5>

                        <!-- Paymob (Cards + Wallet) -->
                        <div class="card mb-3 shadow-sm cursor-pointer"
                            [class.border-primary]="checkoutForm.get('paymentMethod')?.value === 'paymob'"
                            [class.bg-primary-subtle]="checkoutForm.get('paymentMethod')?.value === 'paymob'"
                            (click)="checkoutForm.patchValue({ paymentMethod: 'paymob' })">

                            <div class="card-body d-flex align-items-center p-3">
                                <div class="form-check">
                                    <input class="form-check-input fs-5" type="radio" formControlName="paymentMethod"
                                        value="paymob" id="paymobMethod">
                                </div>
                                <label for="paymobMethod" class="form-check-label ms-3 w-100 cursor-pointer">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-dark"> Card / Wallet</span>
                                    </div>
                                    <div class="small text-muted mt-1">
                                        Pay using bank card or mobile wallet through Paymob.
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Instapay (manual transfer) -->
                        <div class="card mb-3 shadow-sm cursor-pointer"
                            [class.border-primary]="checkoutForm.get('paymentMethod')?.value === 'instapay'"
                            [class.bg-primary-subtle]="checkoutForm.get('paymentMethod')?.value === 'instapay'"
                            (click)="checkoutForm.patchValue({ paymentMethod: 'instapay' })">

                            <div class="card-body d-flex align-items-center p-3">
                                <div class="form-check">
                                    <input class="form-check-input fs-5" type="radio" formControlName="paymentMethod"
                                        value="instapay" id="instapayMethod">
                                </div>
                                <label for="instapayMethod" class="form-check-label ms-3 w-100 cursor-pointer">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-dark">Instapay </span>
                                    </div>
                                    <div class="small text-muted mt-1">
                                        Transfer to our Instapay address, then upload the transaction info.
                                    </div>
                                </label>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 bg-light sticky-top" style="top: 2rem; z-index: 10;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">Order Summary</h5>

                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span>Subtotal</span>
                        <span>{{ cartTotal | currency:'EGP ' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-muted">
                        <span>Delivery</span>
                        <span>{{ deliveryCost > 0 ? (deliveryCost | currency:'EGP ') : 'Select Area' }}</span>
                    </div>

                    <hr class="opacity-25">

                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="fw-bold text-dark">Due Now</span>
                        <span class="fs-3 fw-bold text-black">
                            {{ (checkoutForm.get('onlinePaymentType')?.value === 'deposit' ? deliveryCost : cartTotal +
                            deliveryCost) | currency:'EGP ' }}
                        </span>
                    </div>

                    @if(checkoutForm.get('onlinePaymentType')?.value === 'deposit') {
                    <div class="text-end text-danger fw-medium fw-bold mb-4">
                        + {{ cartTotal | currency:'EGP ' }} due on delivery
                    </div>
                    } @else {
                    <div class="mb-4"></div> }

                    <button
                        class="btn btn-black w-100 py-3 rounded-3 fw-bold shadow-sm d-flex justify-content-center gap-2"
                        [disabled]="checkoutForm.invalid || isSubmitting" (click)="placeOrder()">

                        @if(isSubmitting) {
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        } @else {
                        <span>Place Order</span>
                        <i class="bi bi-arrow-right"></i>
                        }
                    </button>
                </div>
            </div>
        </div>

    </div>

  
</div>
<div class="modal fade" id="manageGovModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">

            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Manage Delivery Areas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-4">

                <div class="bg-light p-3 rounded-3 mb-4">
                    <h6 class="fw-bold small text-muted mb-2">ADD NEW AREA</h6>
                    <form [formGroup]="govForm" (ngSubmit)="saveGovernorate()" class="d-flex gap-2">
                        <input type="text" class="form-control" placeholder="Governorate Name" formControlName="name">
                        <input type="number" class="form-control" placeholder="Price" formControlName="deliveryPrice"
                            style="max-width: 100px;">
                        <button type="submit" class="btn btn-primary fw-bold px-3" [disabled]="govForm.invalid">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </form>
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="ps-3">Name</th>
                                <th>Delivery Cost</th>
                                <th class="text-end pe-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (gov of currentGovernorates; track gov.id) {
                            <tr>
                                <td class="ps-3">
                                    @if(editingGovId === gov.id) {
                                    <input type="text" class="form-control form-control-sm"
                                        [(ngModel)]="gov.governorateName">
                                    } @else {
                                    <span class="fw-bold text-dark">{{ gov.governorateName }}</span>
                                    }
                                </td>

                                <td>
                                    @if(editingGovId === gov.id) {
                                    <input type="number" class="form-control form-control-sm"
                                        [(ngModel)]="gov.deliveryPrice" style="width: 80px;">
                                    } @else {
                                    <span class="badge bg-success bg-opacity-10 text-success">{{ gov.deliveryPrice |
                                        currency:'EGP ' }}</span>
                                    }
                                </td>

                                <td class="text-end pe-3">
                                    @if(editingGovId === gov.id) {
                                    <button class="btn btn-sm btn-success me-1" (click)="updateGovernorate(gov)">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light text-danger" (click)="cancelEdit()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    } @else {
                                    <button class="btn btn-sm btn-light text-primary me-1" (click)="startEdit(gov.id)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light text-danger"
                                        (click)="deleteGovernorate(gov.id)">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    }
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>