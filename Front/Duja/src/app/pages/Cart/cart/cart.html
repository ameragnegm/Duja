<div class="container py-5" style="min-height: 80vh;">

  <div class="d-flex align-items-center mb-4 gap-2">
    <h2 class="fw-bold m-0 text-dark">Shopping Bag</h2>
    <span class="badge bg-light text-dark border rounded-pill">{{ cartItems.length }} Items</span>
  </div>

  @if (cartItems.length > 0) {
  <div class="row g-5">

    <div class="col-lg-8">

      <div class="d-flex flex-column gap-4">
        @for (item of cartItems; track $index) {
        <div class="position-relative d-flex align-items-start gap-3 border-bottom pb-4">

          <div class="cart-img-wrapper bg-light rounded-3 overflow-hidden flex-shrink-0"
            style="width: 120px; height: 150px;">
            @if (item.product.images && item.product.images.length > 0) {
            <img [src]="global.getImageUrl(item.product.images[0].imageUrl)" [alt]="item.product.name"
              class="w-100 h-100 object-fit-cover">
            } @else {
            <img src="https://via.placeholder.com/150" class="w-100 h-100 object-fit-cover opacity-50">
            }
          </div>

          <div class="flex-grow-1">

            <div class="d-flex justify-content-between align-items-start mb-1">
              <h5 class="fw-bold mb-0">
                <a [routerLink]="['/product', item.product.id]" class="text-dark text-decoration-none hover-underline">
                  {{ item.product.name }}
                </a>
              </h5>
              <span class="fw-bold text-dark">{{ (item.product.price * item.quantity) | currency:'EGP ' }}</span>
            </div>

            @if (editingItem === item) {
            <div class="mt-2 p-3 bg-light rounded-3 border">
              <div class="small fw-bold text-muted mb-2">UPDATE OPTIONS</div>
              <div class="d-flex gap-2 mb-3">
                <select class="form-select form-select-sm" [(ngModel)]="editSizeId" (change)="editColorId = null">
                  @for (size of getAvailableSizesForItem(item); track size.id) {
                  <option [value]="size.id">{{ size.name }}</option>
                  }
                </select>
                <select class="form-select form-select-sm" [(ngModel)]="editColorId" [disabled]="!editSizeId">
                  @for (color of getAvailableColorsForItem(item, editSizeId!); track color.id) {
                  <option [value]="color.id">{{ color.name }}</option>
                  }
                </select>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-dark flex-grow-1" (click)="saveEdit()">Update</button>
                <button class="btn btn-sm btn-outline-secondary flex-grow-1" (click)="cancelEdit()">Cancel</button>
              </div>
            </div>
            } @else {
            <div class="text-muted small mb-3">
              {{ getSizeName(item.variant.sizeID) }} / {{ getColorName(item.variant.colorID) }}
              <span class="mx-2 text-muted opacity-25">|</span>
              <a role="button" (click)="startEditing(item)"
                class="text-primary text-decoration-none fw-semibold">Edit</a>
            </div>

            <div class="d-flex align-items-center justify-content-between">

              <div class="quantity-wrapper d-flex align-items-center border rounded-pill px-2"
                style="width: 110px; height: 38px;">
                <button class="btn btn-link text-dark p-0" (click)="decreaseQty(item)" [disabled]="item.quantity <= 1">
                  <i class="bi bi-dash"></i>
                </button>
                <input type="text" class="form-control border-0 text-center fw-bold p-0 bg-transparent"
                  [value]="item.quantity" readonly>
                <button class="btn btn-link text-dark p-0" (click)="increaseQty(item)"
                  [disabled]="item.quantity >= item.variant.stockQuantity">
                  <i class="bi bi-plus"></i>
                </button>
              </div>

              <button class="btn btn-link text-secondary p-0" (click)="removeItem(item)" title="Remove">
                <i class="bi bi-trash3"></i>
              </button>
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>

    <div class="col-lg-4">
      <div class="sticky-top" style="top: 2rem; z-index: 10;">
        <div class="card border-0 bg-light rounded-4 p-4">
          <h5 class="fw-bold mb-3">Summary</h5>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span>{{ cartSubtotal | currency:'EGP ' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-4">
            <span class="text-muted">Delivery</span>
            <span class="text-muted fst-italic">Calculated at checkout</span>
          </div>

          <hr class="text-muted opacity-25">

          <div class="d-flex justify-content-between mb-4">
            <span class="fw-bold fs-5">Total</span>
            <span class="fw-bold fs-5 text-dark">{{ cartSubtotal | currency:'EGP ' }}</span>
          </div>

          <div class="d-flex flex-column gap-2">
            <a routerLink="/checkout" class="btn btn-black py-3 rounded-3 fw-bold">
              Go to Checkout <i class="bi bi-arrow-right ms-2"></i>
            </a>

            <a [routerLink]="['/manage/orders/add']" class="btn btn-outline-dark py-2 rounded-3 fw-semibold">
              <i class="bi bi-plus-lg me-1"></i> Create Order (Admin)
            </a>
          </div>

        </div>

        <div class="text-center mt-3">
          <a href="/home#shop-section" class="text-muted text-decoration-none small fw-semibold hover-underline">
            Or Continue Shopping
          </a>
        </div>

      </div>
    </div>

  </div>
  } @else {
  <div class="d-flex flex-column align-items-center justify-content-center py-5 text-center fade-in">
    <div class="bg-light rounded-circle p-4 mb-3 d-flex align-items-center justify-content-center"
      style="width: 100px; height: 100px;">
      <i class="bi bi-bag text-muted display-4"></i>
    </div>
    <h3 class="fw-bold text-dark">Your bag is empty</h3>
    <p class="text-muted mb-4">Looks like you haven't added anything yet.</p>
    <a href="/home#shop-section" class="btn btn-black rounded-pill px-5 py-3 fw-bold">
      Start Shopping
    </a>
  </div>
  }
</div>